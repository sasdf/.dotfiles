#!/bin/bash

set -euo pipefail

# find pattern argument from "$@"
PATTERN=""
for p in "$@"; do
  if [[ ! "$p" =~ ^- ]]; then
    PATTERN="$p"
    break
  fi
done

if [[ -z "$PATTERN" ]]; then
  echo "Error: No pattern provided."
  exit 1
fi

echo "Searching with ${PATTERN} ..."

mapfile -d $'\0' files < <(grep -rPIl --null "$@")

# Now, use the prefixed files as arguments to another command
if [[ ${#files[@]} -eq 0 ]]; then
  echo "No files found."
  exit -1
fi

# Prefix each element with "./"
prefixed_files=()
for file in "${files[@]}"; do
  prefixed_files+=("./${file}")
done

export PATTERN
exec kak -e '
    set-register slash %sh{ printf "%s" "${PATTERN}" }
    execute-keys nvv
  ' -- "${prefixed_files[@]}"
